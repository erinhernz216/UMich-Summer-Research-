

#Reading in one of the datasets that is completely lacking gene symbol or gene ID annotation:
#This one is for Annaka's meta-analysis: GSE81024

#Before starting, I looked at the Gemma's page for GSE81024:
https://gemma.msl.ubc.ca/expressionExperiment/showExpressionExperiment.html?id=13018
#and found the ID for the platform - in this case the platform was an Agilent microarray chip, and the ID for that platform is GPL7202

#If I type "GPL7202" into Google, the first thing that pops up is GEO's Accession viewer:
https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GPL7202
#This page contains the annotation for the probes provided by the Agilent company
#If I scroll down to the bottom of this page there is a data table with the gene annotation for each probe.
#Under that table is the option "Download full table" - I download it to the same folder where I am storing the differential expression results for GSE81024.

#Alright, the first part of the code is the same as what we did for the other datasets:

#I set the working directory to where I have the files for GSE81024:
> setwd("~/Desktop/GSE27532_Effects of Desipramine ")

#I determine which files are there:
list.files()
# [1] "analysis.results.txt"                     "code R.R"                                
# [3] "Platform_Annotation_GSE27532.txt"         "resultset_ID503861.data.txt"             
# [5] "TempResultsJoined_NoNA_NoMultimapped.csv" "TempResultsJoined.csv" 

#And then I plug the file names for the resultsets into the ReadingInGemmaDE function:
ReadingInGemmaDE(ResultSetFileNames=c("resultset_ID503861.data.txt"))

str(TempResultsJoined)
# 'data.frame':	25680 obs. of  7 variables:
#   $ Element_Name          : chr  "ILMN_2742209" "ILMN_2696876" "ILMN_2481009" "ILMN_2698738" ...
# $ Gene_Symbol           : logi  NA NA NA NA NA NA ...
# $ Gene_Name             : logi  NA NA NA NA NA NA ...
# $ NCBI_ID               : logi  NA NA NA NA NA NA ...
# $ FoldChange_desipramine: num  -0.0186 0.056 0.0973 -0.0156 -0.0104 ...
# $ Tstat_desipramine     : num  -0.486 1.468 2.392 -0.297 -0.322 ...
# $ PValue_desipramine    : num  0.636 0.168 0.034 0.771 0.753 ...


#This is where things differ: 

#Now I read in the additional annotation for the Agilent microarray chip that we got off the GEO website:
MoreAnnotation<-read.delim("Platform_Annotation_GSE27532.txt", sep="\t", header=TRUE, stringsAsFactors = FALSE, comment.char = "#")

str(MoreAnnotation)
# 'data.frame':	25697 obs. of  28 variables:
#   $ ID                   : chr  "ILMN_2659724" "ILMN_2706226" "ILMN_1217123" "ILMN_2780205" ...
# $ Species              : chr  "Mus musculus" "Mus musculus" "Mus musculus" "Mus musculus" ...
# $ Source               : chr  "RefSeq" "RefSeq" "RefSeq" "RefSeq" ...
# $ Search_Key           : chr  "ILMN_215452" "ILMN_201563" "ILMN_195313" "ILMN_213176" ...
# $ Transcript           : chr  "ILMN_215452" "ILMN_201563" "ILMN_195313" "ILMN_213176" ...
# $ ILMN_Gene            : chr  "GPR135" "OLFR811" "ZFPN1A2" "CTNNA1" ...
# $ Source_Reference_ID  : chr  "NM_181752.1" "NM_146552.1" "NM_011770.2" "NM_009818.1" ...
# $ RefSeq_ID            : chr  "NM_181752.1" "NM_146552.1" "NM_011770.2" "NM_009818.1" ...
# $ Entrez_Gene_ID       : int  238252 258545 22779 12385 66368 16694 13114 433722 72149 NA ...
# $ GI                   : int  32306523 33239341 31544068 6753293 21313509 6754489 6681116 126032324 21312399 31541851 ...
# $ Accession            : chr  "NM_181752.1" "NM_146552.1" "NM_011770.2" "NM_009818.1" ...
# $ Symbol               : chr  "Gpr135" "Olfr811" "Zfpn1a2" "Ctnna1" ...
# $ Protein_Product      : chr  "NP_861417.1" "NP_666763.1" "NP_035900.2" "NP_033948.1" ...
# $ Array_Address_Id     : int  1030692 4180338 4560541 70753 5340730 6180647 3890193 2810497 7150360 7550356 ...
# $ Probe_Type           : chr  "S" "S" "S" "S" ...
# $ Probe_Start          : int  1292 595 1 3452 1403 517 1610 535 1425 4426 ...
# $ SEQUENCE             : chr  "CTTCTTCCGAGAGGGTCCACCGGACTCAGTTATGGAAGTCGGCAAACTGC" "CTTTAGCTGTTATGACACTTGTGATCACCTTGATCTTAGTGATTCTCTCC" "CAGTGTTCTGTCCACAGTCCATTCCTCTTTGACTCTTGGAATAGAAGGTC" "CACCATCGGGCTCATTTCTAATCGTCGCAGTGTTTCCTGCTTTGGGCCAG" ...
# $ Chromosome           : chr  "12" "10" "1" "18" ...
# $ Probe_Chr_Orientation: chr  "-" "-" "-" "+" ...
# $ Probe_Coordinates    : chr  "73170637-73170686" "129238935-129238984" "69618979-69619028" "35414205-35414254" ...
# $ Cytoband             : chr  "12qC3" "10qD3" "1qC3" "18qB1" ...
# $ Definition           : chr  "Mus musculus G protein-coupled receptor 135 (Gpr135), mRNA." "Mus musculus olfactory receptor 811 (Olfr811), mRNA." "Mus musculus IKAROS family zinc finger 2 (Ikzf2), mRNA." "Mus musculus catenin (cadherin associated protein), alpha 1 (Ctnna1), mRNA." ...
# $ Ontology_Component   : chr  "integral to membrane [goid 16021] [evidence IEA]; membrane [goid 16020] [evidence IEA]" "integral to membrane [goid 16021] [evidence ISS]; membrane [goid 16020] [evidence IEA]" "intracellular [goid 5622] [evidence IEA]; nucleus [goid 5634] [evidence IEA]; transcription factor complex [goi"| __truncated__ "lamellipodium [goid 30027] [evidence IDA]; cytoskeleton [goid 5856] [evidence IEA]; adherens junction [goid 591"| __truncated__ ...
# $ Ontology_Process     : chr  "G-protein coupled receptor protein signaling pathway [goid 7186] [evidence IEA]; signal transduction [goid 7165"| __truncated__ "G-protein coupled receptor protein signaling pathway [goid 7186] [evidence ISS]; signal transduction [goid 7165"| __truncated__ "regulation of transcription, DNA-dependent [goid 6355] [evidence IEA]; transcription [goid 6350] [evidence IEA]" "cell adhesion [goid 7155] [evidence IEA]" ...
# $ Ontology_Function    : chr  "receptor activity [goid 4872] [evidence IEA]; signal transducer activity [goid 4871] [evidence IEA]; rhodopsin-"| __truncated__ "olfactory receptor activity [goid 4984] [evidence ISS]; receptor activity [goid 4872] [evidence IEA]; signal tr"| __truncated__ "nucleic acid binding [goid 3676] [evidence IEA]; metal ion binding [goid 46872] [evidence IEA]; zinc ion bindin"| __truncated__ "actin filament binding [goid 51015] [evidence IDA]; structural molecule activity [goid 5198] [evidence IEA]; ca"| __truncated__ ...
# $ Synonyms             : chr  "PAFR" "MOR110-6" "Zfpn1a2; Helios; Znfn1a2" "2010010M04Rik; AA517462; AI988031; Catna1" ...
# $ Obsolete_Probe_Id    : chr  "scl00238252.1_311-S-5" "scl0258545.1_17-S-6" "scl022779.1_70-S-1" "" ...
# $ GB_ACC               : chr  "NM_181752.1" "NM_146552.1" "NM_011770.2" "NM_009818.1" ...


colnames(MoreAnnotation)
# [1] "ID"                    "Species"               "Source"                "Search_Key"           
# [5] "Transcript"            "ILMN_Gene"             "Source_Reference_ID"   "RefSeq_ID"            
# [9] "Entrez_Gene_ID"        "GI"                    "Accession"             "Symbol"               
# [13] "Protein_Product"       "Array_Address_Id"      "Probe_Type"            "Probe_Start"          
# [17] "SEQUENCE"              "Chromosome"            "Probe_Chr_Orientation" "Probe_Coordinates"    
# [21] "Cytoband"              "Definition"            "Ontology_Component"    "Ontology_Process"     
# [25] "Ontology_Function"     "Synonyms"              "Obsolete_Probe_Id"     "GB_ACC" 

#I pull out just the columns for the probe ID, gene symbol, and gene name (and Entrez or NCBI ID, if available) and stash them in a new, smaller data frame:
NeededAnnotation<-MoreAnnotation[,c(1,12,22)]


str(NeededAnnotation)
# 'data.frame':	25697 obs. of  3 variables:
#   $ ID        : chr  "ILMN_2659724" "ILMN_2706226" "ILMN_1217123" "ILMN_2780205" ...
# $ Symbol    : chr  "Gpr135" "Olfr811" "Zfpn1a2" "Ctnna1" ...
# $ Definition: chr  "Mus musculus G protein-coupled receptor 135 (Gpr135), mRNA." "Mus musculus olfactory receptor 811 (Olfr811), mRNA." "Mus musculus IKAROS family zinc finger 2 (Ikzf2), mRNA." "Mus musculus catenin (cadherin associated protein), alpha 1 (Ctnna1), mRNA." ...

colnames(TempResultsJoined)


#So I re-name the columns in NeededAnnotation so that probe ID is named "Element_Name". I also re-name the Gene Symbol and Gene Name columns because I want the new additional annotation to be obvious after we join the data-frames.
colnames(NeededAnnotation)<-c("Element_Name", "Gene_Symbol_New","Gene_Name_New")

#I load the library that contains the join function:
library(plyr)

#And join the two data frames so that the resulting data frame contains the same rows & order as our differential expression results (TempResultsJoined) using the "type=left" parameter:
TempResultsJoined_wAnnotation<-join(TempResultsJoined, NeededAnnotation, by="Element_Name", type="left")

str(TempResultsJoined_wAnnotation)
# 'data.frame':	25680 obs. of  9 variables:
#   $ Element_Name          : chr  "ILMN_2742209" "ILMN_2696876" "ILMN_2481009" "ILMN_2698738" ...
# $ Gene_Symbol           : logi  NA NA NA NA NA NA ...
# $ Gene_Name             : logi  NA NA NA NA NA NA ...
# $ NCBI_ID               : logi  NA NA NA NA NA NA ...
# $ FoldChange_desipramine: num  -0.0186 0.056 0.0973 -0.0156 -0.0104 ...
# $ Tstat_desipramine     : num  -0.486 1.468 2.392 -0.297 -0.322 ...
# $ PValue_desipramine    : num  0.636 0.168 0.034 0.771 0.753 ...
# $ Gene_Symbol_New       : chr  "Sca7" "Srebf1" "V1rd12" "D15Ertd735e" ...
# $ Gene_Name_New         : chr  "Mus musculus ataxin 7 (Atxn7), mRNA." "Mus musculus sterol regulatory element binding factor 1 (Srebf1), mRNA." "" "Mus musculus limb region 1 like (Lmbr1l), mRNA." ...

TempResultsJoined_wAnnotation$Gene_Symbol<-TempResultsJoined_wAnnotation$Gene_Symbol_New
TempResultsJoined_wAnnotation$Gene_Name<-TempResultsJoined_wAnnotation$Gene_Name_New

str(TempResultsJoined_wAnnotation)
# 'data.frame':	25680 obs. of  9 variables:
#   $ Element_Name          : chr  "ILMN_2742209" "ILMN_2696876" "ILMN_2481009" "ILMN_2698738" ...
# $ Gene_Symbol           : chr  "Sca7" "Srebf1" "V1rd12" "D15Ertd735e" ...
# $ Gene_Name             : chr  "Mus musculus ataxin 7 (Atxn7), mRNA." "Mus musculus sterol regulatory element binding factor 1 (Srebf1), mRNA." "" "Mus musculus limb region 1 like (Lmbr1l), mRNA." ...
# $ NCBI_ID               : logi  NA NA NA NA NA NA ...
# $ FoldChange_desipramine: num  -0.0186 0.056 0.0973 -0.0156 -0.0104 ...
# $ Tstat_desipramine     : num  -0.486 1.468 2.392 -0.297 -0.322 ...
# $ PValue_desipramine    : num  0.636 0.168 0.034 0.771 0.753 ...
# $ Gene_Symbol_New       : chr  "Sca7" "Srebf1" "V1rd12" "D15Ertd735e" ...
# $ Gene_Name_New         : chr  "Mus musculus ataxin 7 (Atxn7), mRNA." "Mus musculus sterol regulatory element binding factor 1 (Srebf1), mRNA." "" "Mus musculus limb region 1 like (Lmbr1l), mRNA." ...

TempResultsJoined<-TempResultsJoined_wAnnotation

#And then the rest of the coding should be the same as normal:

FilteringDEResults_GoodAnnotation<-function(TempResultsJoined){
  
  print("# of rows with missing NCBI annotation:")
  print(sum(TempResultsJoined$NCBI_ID==""|TempResultsJoined$NCBI_ID=="null"))
  
  print("# of rows with missing Gene Symbol annotation:")
  print(sum(TempResultsJoined$Gene_Symbol==""|TempResultsJoined$Gene_Symbol=="null"))
  
  print("# of rows mapped to multiple NCBI_IDs:")
  print(length(grep('\\|', TempResultsJoined$NCBI_ID)))
  
  print("# of rows mapped to multiple Gene Symbols:")
  print(length(grep('\\|', TempResultsJoined$Gene_Symbol)))
  
  #I only want the subset of data which contains rows that do not contain a Gene Symbol of ""
  TempResultsJoined_NoNA<-TempResultsJoined[(TempResultsJoined$Gene_Symbol==""|TempResultsJoined$Gene_Symbol=="null")==FALSE,]
  
  if(length(grep('\\|', TempResultsJoined_NoNA$Gene_Symbol))==0){
    TempResultsJoined_NoNA_NoMultimapped<<-TempResultsJoined_NoNA
  }else{
    #I only want rows annotated with a single Gene Symbol (no pipe):
    TempResultsJoined_NoNA_NoMultimapped<<-TempResultsJoined_NoNA[-(grep('\\|', TempResultsJoined_NoNA$Gene_Symbol)),]
  }
  
  print("# of rows with good annotation")
  print(nrow(TempResultsJoined_NoNA_NoMultimapped))
  
  #For record keeping (sometimes useful for troubleshooting later)
  write.csv(TempResultsJoined_NoNA_NoMultimapped, "TempResultsJoined_NoNA_NoMultimapped.csv")
  
  rm(TempResultsJoined_NoNA, TempResultsJoined_NoNA_NoMultimapped)
  
  print("Outputted object: TempResultsJoined_NoNA_NoMultimapped")
}
FilteringDEResults_GoodAnnotation(TempResultsJoined)

# [1] "# of rows with missing NCBI annotation:"
# [1] NA
# [1] "# of rows with missing Gene Symbol annotation:"
# [1] 0
# [1] "# of rows mapped to multiple NCBI_IDs:"
# [1] 0
# [1] "# of rows mapped to multiple Gene Symbols:"
# [1] 0
# [1] "# of rows with good annotation"
# [1] 25680
# [1] "Outputted object: TempResultsJoined_NoNA_NoMultimapped"

str(TempResultsJoined_NoNA_NoMultimapped)
# 'data.frame':	25680 obs. of  9 variables:
#   $ Element_Name          : chr  "ILMN_2742209" "ILMN_2696876" "ILMN_2481009" "ILMN_2698738" ...
# $ Gene_Symbol           : chr  "Sca7" "Srebf1" "V1rd12" "D15Ertd735e" ...
# $ Gene_Name             : chr  "Mus musculus ataxin 7 (Atxn7), mRNA." "Mus musculus sterol regulatory element binding factor 1 (Srebf1), mRNA." "" "Mus musculus limb region 1 like (Lmbr1l), mRNA." ...
# $ NCBI_ID               : logi  NA NA NA NA NA NA ...
# $ FoldChange_desipramine: num  -0.0186 0.056 0.0973 -0.0156 -0.0104 ...
# $ Tstat_desipramine     : num  -0.486 1.468 2.392 -0.297 -0.322 ...
# $ PValue_desipramine    : num  0.636 0.168 0.034 0.771 0.753 ...
# $ Gene_Symbol_New       : chr  "Sca7" "Srebf1" "V1rd12" "D15Ertd735e" ...
# $ Gene_Name_New         : chr  "Mus musculus ataxin 7 (Atxn7), mRNA." "Mus musculus sterol regulatory element binding factor 1 (Srebf1), mRNA." "" "Mus musculus limb region 1 like (Lmbr1l), mRNA." ...

CollapsingDEResults_OneResultPerGene(GSE_ID="GSE27532", TempResultsJoined_NoNA_NoMultimapped, ComparisonsOfInterest = c("GSE27532_Despipramine_vs_control"), NamesOfFoldChangeColumns=list(TempResultsJoined_NoNA_NoMultimapped$FoldChange_desipramine), NamesOfTstatColumns = list(TempResultsJoined_NoNA_NoMultimapped$Tstat_desipramine))

# [1] "Double check that the vectors containing the two fold change and tstat column names contain the same order as the group comparisons of interest - otherwise this function won't work properly!  If the order matches, proceed:"
# [1] "# of rows with unique NCBI IDs:"
# [1] 1
# [1] "# of rows with unique Gene Symbols:"
# [1] 18110
# [1] "Dimensions of Fold Change matrix, averaged by gene symbol:"
# [1] 18110     1
# [1] "Output: Named DEResults_GSE27532"

str(DEResults_GSE27532)
List of 4
# $ Log2FC: num [1:18110, 1] 0.0573 -0.0338 0.022 0.0934 0.04 ...
# ..- attr(*, "dimnames")=List of 2
# .. ..$ : chr [1:18110] "0610005K03Rik" "0610006F02Rik" "0610006I08Rik" "0610006K04Rik" ...
# .. ..$ : chr "GSE27532_Despipramine_vs_control"
# $ Tstat : num [1:18110, 1] 1.265 -0.629 0.204 1.034 0.531 ...
# ..- attr(*, "dimnames")=List of 2
# .. ..$ : chr [1:18110] "0610005K03Rik" "0610006F02Rik" "0610006I08Rik" "0610006K04Rik" ...
# .. ..$ : chr "GSE27532_Despipramine_vs_control"
# $ SE    : num [1:18110, 1] 0.0453 0.0537 0.1131 0.0903 0.0987 ...
# ..- attr(*, "dimnames")=List of 2
# .. ..$ : chr [1:18110] "0610005K03Rik" "0610006F02Rik" "0610006I08Rik" "0610006K04Rik" ...
# .. ..$ : chr "GSE27532_Despipramine_vs_control"
# $ SV    : num [1:18110, 1] 0.00205 0.00289 0.0128 0.00815 0.00974 ...
# ..- attr(*, "dimnames")=List of 2
# .. ..$ : chr [1:18110] "0610005K03Rik" "0610006F02Rik" "0610006I08Rik" "0610006K04Rik" ...
# .. ..$ : chr "GSE27532_Despipramine_vs_control"

